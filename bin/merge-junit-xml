#!/usr/bin/env ruby

require 'nokogiri'

# Merges multiple JUnit XML files into a single file
# Usage: merge-junit-xml output.xml input1.xml input2.xml ...

if ARGV.length < 2
  warn "Usage: #{$0} output.xml input1.xml [input2.xml ...]"
  exit 1
end

output_path = ARGV[0]
input_paths = ARGV[1..-1]

# Create root document
merged_doc = Nokogiri::XML('<?xml version="1.0" encoding="UTF-8"?><testsuites></testsuites>')
root = merged_doc.at('testsuites')

# Stats for the merged result
total_tests = 0
total_failures = 0
total_errors = 0
total_skipped = 0
total_time = 0.0

# Merge all input files
input_paths.each do |input_path|
  unless File.exist?(input_path)
    warn "Warning: File not found: #{input_path}, skipping"
    next
  end

  begin
    doc = File.open(input_path) { |f| Nokogiri::XML(f) }

    # Extract all testsuite elements
    doc.xpath('//testsuite').each do |testsuite|
      # Update stats
      total_tests += testsuite['tests'].to_i
      total_failures += testsuite['failures'].to_i
      total_errors += testsuite['errors'].to_i
      total_skipped += testsuite['skipped'].to_i
      total_time += testsuite['time'].to_f

      # Add testsuite to merged document
      root.add_child(testsuite.dup)
    end
  rescue => e
    warn "Warning: Failed to parse #{input_path}: #{e.message}, skipping"
  end
end

# Update root stats
root['tests'] = total_tests.to_s
root['failures'] = total_failures.to_s
root['errors'] = total_errors.to_s
root['skipped'] = total_skipped.to_s
root['time'] = total_time.round(2).to_s

# Write output
File.write(output_path, merged_doc.to_xml)

puts "Merged #{input_paths.length} files into #{output_path}"
puts "Total: #{total_tests} tests, #{total_time.round(2)}s"
