name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby-version: ['3.2', '3.3', '3.4', '4.0']

    steps:
    - uses: actions/checkout@v6

    - name: Set up Ruby ${{ matrix.ruby-version }}
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true

    - name: Run tests
      run: bundle exec rspec

    - name: Upload coverage to Codecov
      if: matrix.ruby-version == '3.3'
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/.resultset.json
        flags: unittests
        fail_ci_if_error: false

    - name: Upload coverage reports
      if: matrix.ruby-version == '3.3'
      uses: actions/upload-artifact@v6
      with:
        name: coverage-report
        path: coverage/

  parallel-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node_index: [0, 1, 2, 3, 4]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true

    # Restore previous test results for optimal test distribution
    # Priority: 1) Current branch cache, 2) Main branch cache (for first PR run), 3) Any other branch
    - name: Restore previous test results from cache
      uses: actions/cache/restore@v5
      with:
        path: tmp/rspec-results.xml
        key: rspec-results-${{ github.ref }}
        restore-keys: |
          rspec-results-refs/heads/main
          rspec-results-

    - name: Run tests with split-test-rb
      run: |
        mkdir -p tmp
        bundle exec rspec \
          --format progress \
          --format RspecJunitFormatter \
          --out tmp/rspec-results-${{ matrix.node_index }}.xml \
          $(bundle exec split-test-rb \
            --xml-path tmp/rspec-results.xml \
            --node-index ${{ matrix.node_index }} \
            --node-total 5 \
            --debug)

    - name: Upload test results
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: rspec-results-node-${{ matrix.node_index }}
        path: tmp/rspec-results-${{ matrix.node_index }}.xml

  merge-test-results:
    runs-on: ubuntu-latest
    needs: parallel-test
    if: always()
    steps:
    - uses: actions/checkout@v6

    - name: Download all test results
      uses: actions/download-artifact@v7
      with:
        pattern: rspec-results-node-*
        path: tmp/results/
        merge-multiple: true

    - name: Merge test results
      run: |
        # Merge all XML files into one for next run
        cat tmp/results/rspec-results-*.xml > tmp/rspec-results.xml || echo "<testsuites></testsuites>" > tmp/rspec-results.xml

    - name: Upload merged test results
      uses: actions/upload-artifact@v6
      with:
        name: rspec-results
        path: tmp/rspec-results.xml

    - name: Save test results to cache for next run
      uses: actions/cache/save@v5
      with:
        path: tmp/rspec-results.xml
        key: rspec-results-${{ github.ref }}
