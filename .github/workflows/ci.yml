name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby-version: ['2.7', '3.0', '3.1', '3.2', '3.3']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Ruby ${{ matrix.ruby-version }}
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true

    - name: Run tests
      run: bundle exec rspec

    - name: Upload coverage reports
      if: matrix.ruby-version == '3.3'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/

  parallel-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node_index: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true

    - name: Download previous test results
      uses: actions/download-artifact@v4
      with:
        name: rspec-results
        path: tmp/
      continue-on-error: true

    - name: Run tests with split-test-rb
      run: |
        mkdir -p tmp
        bundle exec rspec \
          --format progress \
          --format RspecJunitFormatter \
          --out tmp/rspec-results-${{ matrix.node_index }}.xml \
          $(bundle exec split-test-rb \
            --xml-path tmp/rspec-results.xml \
            --node-index ${{ matrix.node_index }} \
            --node-total 10 \
            --debug)

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: rspec-results-node-${{ matrix.node_index }}
        path: tmp/rspec-results-${{ matrix.node_index }}.xml

  merge-test-results:
    runs-on: ubuntu-latest
    needs: parallel-test
    if: always()
    steps:
    - uses: actions/checkout@v4

    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        pattern: rspec-results-node-*
        path: tmp/results/
        merge-multiple: true

    - name: Merge test results
      run: |
        # Merge all XML files into one for next run
        cat tmp/results/rspec-results-*.xml > tmp/rspec-results.xml || echo "<testsuites></testsuites>" > tmp/rspec-results.xml

    - name: Upload merged test results
      uses: actions/upload-artifact@v4
      with:
        name: rspec-results
        path: tmp/rspec-results.xml
