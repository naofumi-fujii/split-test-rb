name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  rubocop:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true

    - name: Run RuboCop
      run: bundle exec rubocop

  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby-version: ['3.2', '3.3', '3.4', '4.0']

    steps:
    - uses: actions/checkout@v6

    - name: Set up Ruby ${{ matrix.ruby-version }}
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true

    - name: Run tests
      run: bundle exec rspec

    - name: Upload coverage to Codecov
      if: matrix.ruby-version == '3.3'
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/.resultset.json
        flags: unittests
        fail_ci_if_error: false

    - name: Upload coverage reports
      if: matrix.ruby-version == '3.3'
      uses: actions/upload-artifact@v6
      with:
        name: coverage-report
        path: coverage/

  parallel-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node_index: [0, 1, 2, 3, 4]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true

    # Restore previous test results for optimal test distribution
    # Uses prefix matching to find the latest cache from the same branch or main branch
    # Cache key version: increment when changing cache format
    - name: Restore previous test results from cache
      uses: actions/cache/restore@v5
      with:
        path: tmp/rspec-results/
        key: rspec-results-v1-${{ github.ref }}-${{ github.run_id }}
        restore-keys: |
          rspec-results-v1-${{ github.ref }}-
          rspec-results-v1-refs/heads/main-

    - name: Run tests with split-test-rb
      run: |
        mkdir -p tmp/rspec-results
        bundle exec rspec \
          --format progress \
          --format json \
          --out tmp/rspec-results/rspec-results-${{ matrix.node_index }}.json \
          $(bundle exec split-test-rb \
            --json-path tmp/rspec-results/ \
            --node-index ${{ matrix.node_index }} \
            --node-total 5 \
            --test-dir spec \
            --test-pattern '**/*_spec.rb' \
            --debug)

    - name: Upload test results
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: rspec-results-node-${{ matrix.node_index }}
        path: tmp/rspec-results/rspec-results-${{ matrix.node_index }}.json

  cache-test-results:
    runs-on: ubuntu-latest
    needs: parallel-test
    if: always()
    steps:
    - uses: actions/checkout@v6

    - name: Set timestamp
      run: echo "TIMESTAMP=$(date +%s)" >> $GITHUB_ENV

    - name: Download all test results
      uses: actions/download-artifact@v7
      with:
        pattern: rspec-results-node-*
        path: tmp/rspec-results/
        merge-multiple: true

    - name: Upload test results
      uses: actions/upload-artifact@v6
      with:
        name: rspec-results
        path: tmp/rspec-results/

    - name: Save test results to cache for next run
      uses: actions/cache/save@v5
      with:
        path: tmp/rspec-results/
        key: rspec-results-v1-${{ github.ref }}-${{ env.TIMESTAMP }}
